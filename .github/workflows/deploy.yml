name: Deploy

on:
  push:
    branches: [development]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: self-hosted
    environment: production
    needs: []
    steps:
      - name: Clean root-owned files from workspace
        run: |
          # Docker bind-mount로 생성된 root 소유 파일 정리
          docker run --rm -v "${{ github.workspace }}:/workspace" alpine \
            sh -c "rm -rf /workspace/.telegram_sessions" || true

      - uses: actions/checkout@v4

      - name: Copy .env from project
        run: cp /home/youngs75/projects/prime-jennie/.env .env

      - name: Build & deploy with Docker Compose
        env:
          DOCKER_BUILDKIT: "1"
          COMPOSE_DOCKER_CLI_BUILD: "1"
          COMPOSE_PROJECT_NAME: prime-jennie
        run: |
          echo "Deploying: $(git log --oneline -1)"

          # Prune old build cache
          docker builder prune -f --filter "until=24h" || true

          # Infra first (Redis, MariaDB, Qdrant, etc.)
          docker compose --profile infra up -d

          # Wait for Redis & MariaDB to be ready
          echo "Waiting for infra services..."
          sleep 10

          # Build & deploy app services
          docker compose --profile real up -d --build

          # Cleanup dangling images
          docker image prune -f || true

          echo ""
          echo "=== Deployment complete ==="
          docker compose --profile infra --profile real ps
