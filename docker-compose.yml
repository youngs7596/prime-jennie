name: prime-jennie

# ============================================================================
# 공통 앵커
# ============================================================================
x-service-defaults: &service-defaults
  build:
    context: .
    dockerfile: Dockerfile
  env_file: .env
  restart: unless-stopped
  network_mode: host
  labels:
    - stack=prime-jennie

x-env-common: &env-common
  TZ: Asia/Seoul
  DB_HOST: 127.0.0.1
  DB_PORT: "3307"
  DB_USER: "${DB_USER:-jennie}"
  DB_PASSWORD: "${DB_PASSWORD:-q1w2e3R$}"
  DB_NAME: "${DB_NAME:-jennie_db}"
  REDIS_HOST: 127.0.0.1
  REDIS_PORT: "6379"
  KIS_GATEWAY_URL: http://127.0.0.1:8080
  APP_LOG_LEVEL: INFO
  APP_TIMEZONE: Asia/Seoul

# ============================================================================
# Infrastructure Services (profile: infra)
# ============================================================================
services:
  mariadb:
    image: mariadb:10.11
    profiles: ["infra"]
    environment:
      MARIADB_ROOT_PASSWORD: "${DB_PASSWORD:-q1w2e3R$}"
      MARIADB_USER: "${DB_USER:-jennie}"
      MARIADB_PASSWORD: "${DB_PASSWORD:-q1w2e3R$}"
      MARIADB_DATABASE: "${DB_NAME:-jennie_db}"
    command: --lower_case_table_names=1 --port=3307 --innodb_buffer_pool_size=1G
    volumes:
      - ${DOCKER_DATA_DIR:-/docker_data}/mariadb_data:/var/lib/mysql
    restart: always
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    network_mode: host
    labels:
      - app=mariadb
      - stack=prime-jennie

  redis:
    image: redis:alpine
    profiles: ["infra"]
    ports:
      - "6379:6379"
    volumes:
      - ${DOCKER_DATA_DIR:-/docker_data}/redis_data:/data
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    network_mode: host
    labels:
      - app=redis
      - stack=prime-jennie

  qdrant:
    image: qdrant/qdrant:latest
    profiles: ["infra"]
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ${DOCKER_DATA_DIR:-/docker_data}/qdrant_data:/qdrant/storage
    restart: always
    environment:
      QDRANT__SERVICE__GRPC_PORT: "6334"
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'cat < /dev/tcp/localhost/6333'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    network_mode: host
    labels:
      - app=qdrant
      - stack=prime-jennie

  # ============================================================================
  # Observability (profile: infra)
  # ============================================================================
  loki:
    image: grafana/loki:2.9.0
    profiles: ["infra"]
    user: "1000"
    command: -config.file=/etc/loki/loki-config.yaml
    volumes:
      - ./infra/loki/loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - ${DOCKER_DATA_DIR:-/docker_data}/loki_data:/loki
    restart: unless-stopped
    network_mode: host
    labels:
      - app=loki
      - stack=prime-jennie

  promtail:
    image: grafana/promtail:3.3.2
    profiles: ["infra"]
    command: -config.file=/etc/promtail/promtail-config.yaml
    volumes:
      - ./infra/promtail/promtail-config.yaml:/etc/promtail/promtail-config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    restart: unless-stopped
    network_mode: host
    labels:
      - app=promtail
      - stack=prime-jennie

  grafana:
    image: grafana/grafana:10.4.0
    profiles: ["infra"]
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_PASSWORD:-admin}"
      GF_SERVER_HTTP_PORT: "3300"
    volumes:
      - ${DOCKER_DATA_DIR:-/docker_data}/grafana_data:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning:ro
    restart: unless-stopped
    network_mode: host
    labels:
      - app=grafana
      - stack=prime-jennie

  # ============================================================================
  # vLLM (profile: infra)
  # ============================================================================
  vllm-llm:
    image: vllm/vllm-openai:v0.15.1
    profiles: ["gpu"]
    ipc: host
    environment:
      HF_HUB_OFFLINE: "1"
    command: >
      LGAI-EXAONE/EXAONE-4.0-32B-AWQ
      --port 8001
      --gpu-memory-utilization 0.85
      --max-model-len 4096
      --quantization awq_marlin
      --dtype half
      --trust-remote-code
      --enforce-eager
    volumes:
      - ${DOCKER_DATA_DIR:-/docker_data}/huggingface_cache:/root/.cache/huggingface
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8001/v1/models')\""]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    network_mode: host
    labels:
      - app=vllm-llm
      - stack=prime-jennie

  vllm-embed:
    image: vllm/vllm-openai:v0.15.1
    profiles: ["gpu"]
    ipc: host
    environment:
      HF_HUB_OFFLINE: "1"
    command: >
      nlpai-lab/KURE-v1
      --port 8002
      --gpu-memory-utilization 0.05
      --max-model-len 256
      --dtype half
      --trust-remote-code
      --enforce-eager
    volumes:
      - ${DOCKER_DATA_DIR:-/docker_data}/huggingface_cache:/root/.cache/huggingface
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8002/v1/models')\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    network_mode: host
    labels:
      - app=vllm-embed
      - stack=prime-jennie

  # ============================================================================
  # Application Services (profile: real)
  # ============================================================================
  kis-gateway:
    <<: *service-defaults
    profiles: ["real"]
    environment:
      <<: *env-common
      PORT: "8080"
      KIS_APP_KEY: "${KIS_APP_KEY}"
      KIS_APP_SECRET: "${KIS_APP_SECRET}"
      KIS_ACCOUNT_NO: "${KIS_ACCOUNT_NO}"
      APP_TRADING_MODE: REAL
    volumes:
      - ${DOCKER_DATA_DIR:-/docker_data}/kis_token:/app/config
    command: ["uvicorn", "prime_jennie.services.gateway.app:app", "--host", "0.0.0.0", "--port", "8080"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - app=kis-gateway
      - stack=prime-jennie

  scout-job:
    <<: *service-defaults
    profiles: ["real"]
    depends_on:
      kis-gateway:
        condition: service_healthy
    environment:
      <<: *env-common
      PORT: "8087"
      SCORING_QUANT_SCORER_VERSION: v2
      SCORING_UNIFIED_ANALYST_ENABLED: "true"
      SCOUT_MAX_WATCHLIST_SIZE: "25"
      LLM_TIER_FAST_PROVIDER: ollama
      LLM_TIER_REASONING_PROVIDER: deepseek_cloud
      LLM_VLLM_LLM_URL: http://127.0.0.1:8001/v1
      LLM_VLLM_EMBED_URL: http://127.0.0.1:8002/v1
    command: ["uvicorn", "prime_jennie.services.scout.app:app", "--host", "0.0.0.0", "--port", "8087"]
    labels:
      - app=scout-job
      - stack=prime-jennie

  buy-scanner:
    <<: *service-defaults
    profiles: ["real"]
    depends_on:
      kis-gateway:
        condition: service_healthy
    environment:
      <<: *env-common
      PORT: "8081"
      SCANNER_CONVICTION_ENTRY_ENABLED: "false"
      SCANNER_ORB_ENABLED: "true"
      SCANNER_MOMENTUM_LIMIT_ORDER_ENABLED: "true"
      SCANNER_MOMENTUM_CONFIRMATION_BARS: "1"
    command: ["uvicorn", "prime_jennie.services.scanner.app:app", "--host", "0.0.0.0", "--port", "8081"]
    labels:
      - app=buy-scanner
      - stack=prime-jennie

  buy-executor:
    <<: *service-defaults
    profiles: ["real"]
    depends_on:
      kis-gateway:
        condition: service_healthy
    environment:
      <<: *env-common
      PORT: "8082"
      RISK_PORTFOLIO_GUARD_ENABLED: "true"
      RISK_DYNAMIC_SECTOR_BUDGET_ENABLED: "true"
      RISK_MAX_PORTFOLIO_SIZE: "10"
      RISK_MAX_BUY_COUNT_PER_DAY: "6"
    command: ["uvicorn", "prime_jennie.services.buyer.app:app", "--host", "0.0.0.0", "--port", "8082"]
    labels:
      - app=buy-executor
      - stack=prime-jennie

  sell-executor:
    <<: *service-defaults
    profiles: ["real"]
    depends_on:
      kis-gateway:
        condition: service_healthy
    environment:
      <<: *env-common
      PORT: "8083"
    command: ["uvicorn", "prime_jennie.services.seller.app:app", "--host", "0.0.0.0", "--port", "8083"]
    labels:
      - app=sell-executor
      - stack=prime-jennie

  price-monitor:
    <<: *service-defaults
    profiles: ["real"]
    depends_on:
      kis-gateway:
        condition: service_healthy
    environment:
      <<: *env-common
      PORT: "8088"
      SELL_TRAILING_ENABLED: "true"
      SELL_TRAILING_ACTIVATION_PCT: "5.0"
      SELL_STOP_LOSS_PCT: "5.0"
    command: ["uvicorn", "prime_jennie.services.monitor.app:app", "--host", "0.0.0.0", "--port", "8088"]
    labels:
      - app=price-monitor
      - stack=prime-jennie

  macro-council:
    <<: *service-defaults
    profiles: ["real"]
    environment:
      <<: *env-common
      PORT: "8089"
      LLM_TIER_REASONING_PROVIDER: deepseek_cloud
      LLM_TIER_THINKING_PROVIDER: deepseek_cloud
      TELEGRAM_API_ID: "${TELEGRAM_API_ID}"
      TELEGRAM_API_HASH: "${TELEGRAM_API_HASH}"
    volumes:
      - ${DOCKER_DATA_DIR:-/docker_data}/telegram_sessions:/app/.telegram_sessions
    command: ["uvicorn", "prime_jennie.services.council.app:app", "--host", "0.0.0.0", "--port", "8089"]
    labels:
      - app=macro-council
      - stack=prime-jennie

  news-pipeline:
    <<: *service-defaults
    profiles: ["real"]
    environment:
      <<: *env-common
      PORT: "8092"
      LLM_TIER_FAST_PROVIDER: ollama
      LLM_VLLM_LLM_URL: http://127.0.0.1:8001/v1
      LLM_VLLM_EMBED_URL: http://127.0.0.1:8002/v1
      INFRA_QDRANT_URL: http://127.0.0.1:6333
    command: ["uvicorn", "prime_jennie.services.news.app:app", "--host", "0.0.0.0", "--port", "8092"]
    labels:
      - app=news-pipeline
      - stack=prime-jennie

  dashboard:
    <<: *service-defaults
    profiles: ["real"]
    environment:
      <<: *env-common
      PORT: "8090"
    command: ["uvicorn", "prime_jennie.services.dashboard.app:app", "--host", "0.0.0.0", "--port", "8090"]
    labels:
      - app=dashboard
      - stack=prime-jennie

  dashboard-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    profiles: ["real"]
    restart: unless-stopped
    network_mode: host
    depends_on:
      - dashboard
    labels:
      - app=dashboard-frontend
      - stack=prime-jennie

  daily-briefing:
    <<: *service-defaults
    profiles: ["real"]
    environment:
      <<: *env-common
      PORT: "8086"
      LLM_TIER_FAST_PROVIDER: ollama
    command: ["uvicorn", "prime_jennie.services.briefing.app:app", "--host", "0.0.0.0", "--port", "8086"]
    labels:
      - app=daily-briefing
      - stack=prime-jennie

  telegram:
    <<: *service-defaults
    profiles: ["real"]
    environment:
      <<: *env-common
      PORT: "8091"
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN}"
      TELEGRAM_CHAT_IDS: "${TELEGRAM_CHAT_IDS}"
    command: ["uvicorn", "prime_jennie.services.telegram.app:app", "--host", "0.0.0.0", "--port", "8091"]
    labels:
      - app=telegram
      - stack=prime-jennie

  job-worker:
    <<: *service-defaults
    profiles: ["real"]
    environment:
      <<: *env-common
      PORT: "8095"
      LLM_TIER_FAST_PROVIDER: ollama
      LLM_VLLM_LLM_URL: http://127.0.0.1:8001/v1
      INFRA_QDRANT_URL: http://127.0.0.1:6333
    command: ["uvicorn", "prime_jennie.services.jobs.app:app", "--host", "0.0.0.0", "--port", "8095"]
    labels:
      - app=job-worker
      - stack=prime-jennie

  # ============================================================================
  # Airflow (profile: real)
  # ============================================================================
  airflow-webserver:
    <<: *service-defaults
    profiles: ["real"]
    entrypoint: ["bash", "/app/scripts/airflow-entrypoint.sh"]
    environment:
      <<: *env-common
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__DAGS_FOLDER: /app/dags
      AIRFLOW__CORE__FERNET_KEY: "${AIRFLOW_FERNET_KEY}"
      AIRFLOW__CORE__SECRET_KEY: "${AIRFLOW_SECRET_KEY}"
      AIRFLOW__API_AUTH__JWT_SECRET: "${AIRFLOW_JWT_SECRET}"
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: "mysql+mysqldb://${DB_USER:-jennie}:${DB_PASSWORD:-q1w2e3R$}@127.0.0.1:3307/${DB_NAME:-jennie_db}"
      AIRFLOW__WEBSERVER__WEB_SERVER_PORT: "8085"
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW_HOME: /app/airflow_home
      AIRFLOW_ADMIN_PASSWORD: "${AIRFLOW_ADMIN_PASSWORD:-admin}"
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN}"
      TELEGRAM_CHAT_IDS: "${TELEGRAM_CHAT_IDS}"
    command: ["airflow", "api-server", "--port", "8085"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/api/v2/monitor/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - app=airflow-webserver
      - stack=prime-jennie

  airflow-scheduler:
    <<: *service-defaults
    profiles: ["real"]
    depends_on:
      airflow-webserver:
        condition: service_healthy
    entrypoint: ["bash", "/app/scripts/airflow-entrypoint.sh"]
    environment:
      <<: *env-common
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__DAGS_FOLDER: /app/dags
      AIRFLOW__CORE__FERNET_KEY: "${AIRFLOW_FERNET_KEY}"
      AIRFLOW__CORE__SECRET_KEY: "${AIRFLOW_SECRET_KEY}"
      AIRFLOW__API_AUTH__JWT_SECRET: "${AIRFLOW_JWT_SECRET}"
      AIRFLOW__CORE__EXECUTION_API_SERVER_URL: "http://localhost:8085/execution/"
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: "mysql+mysqldb://${DB_USER:-jennie}:${DB_PASSWORD:-q1w2e3R$}@127.0.0.1:3307/${DB_NAME:-jennie_db}"
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW_HOME: /app/airflow_home
      AIRFLOW_ADMIN_PASSWORD: "${AIRFLOW_ADMIN_PASSWORD:-admin}"
    command: ["airflow", "scheduler"]
    labels:
      - app=airflow-scheduler
      - stack=prime-jennie

  # ============================================================================
  # Cloudflare Tunnel (profile: infra)
  # ============================================================================
  cloudflared:
    image: cloudflare/cloudflared:latest
    profiles: ["infra"]
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    network_mode: host
    restart: unless-stopped
    labels:
      - app=cloudflared
      - stack=prime-jennie
