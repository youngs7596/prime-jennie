# Session Handoff - 2026-02-19-19-30

## 작업 요약 (What was done)

### 데이터 마이그레이션: my-prime-jennie → prime-jennie

레거시 9개 테이블에서 prime-jennie 테이블로 전량 데이터 이관 완료.

#### 변경된 파일
| 파일 | 변경 내용 |
|------|----------|
| `scripts/migrate_from_legacy.py` | 신규 — one-time 마이그레이션 스크립트 |
| `Dockerfile` | `COPY alembic.ini` + `COPY migrations/` 추가 |
| `migrations/env.py` | `version_table="alembic_version_app"` 추가 (Airflow 분리) |

#### 마이그레이션 결과
| 타겟 테이블 | 소스 테이블 | 행수 | 비고 |
|------------|-----------|-----:|------|
| stock_masters | stock_master | 1,028 | 100% |
| stock_daily_prices | stock_daily_prices_3y | 512,296 | FK 필터, 레거시 동명 테이블 rename 후 재생성 |
| stock_investor_tradings | stock_investor_trading | 162,658 | FK 필터 |
| stock_news_sentiments | stock_news_sentiment | 686,551 | FK 필터 |
| daily_quant_scores | daily_quant_score | 0 | 소스도 비어있음 |
| positions | active_portfolio | 2 | 100% |
| trade_logs | tradelog | 370 | FK 필터, stock_name JOIN |
| daily_asset_snapshots | daily_asset_snapshot | 25 | 100% |
| watchlist_histories | watchlist_history | 4,602 | 100% |

#### 해결한 이슈들
1. **Dockerfile 누락**: `alembic.ini` + `migrations/` 디렉토리가 컨테이너에 복사되지 않음
2. **Alembic 버전 충돌**: Airflow 내장 Alembic과 `alembic_version` 테이블 공유 → `alembic_version_app`으로 분리
3. **Collation 불일치**: 테이블별 `utf8mb4_uca1400_ai_ci` / `utf8mb4_unicode_ci` / `utf8mb4_general_ci` 혼재 → 전체 `utf8mb4_general_ci` 통일
4. **레거시 동명 테이블**: `stock_daily_prices`가 레거시 스키마(UPPER_CASE 컬럼, decimal 타입)로 이미 존재 → rename 후 올바른 스키마로 재생성
5. **대용량 INSERT 타임아웃**: `stock_news_sentiments` 68만 행 INSERT가 Python 커넥션에서 행 → MariaDB 클라이언트 직접 실행

---

## 현재 상태 (Current State)

### 서비스: 23개 전체 정상 가동 (이전 세션과 동일)

### DB 상태
- Alembic: `alembic_version_app` 테이블에 revision `001` (head)
- Airflow: `alembic_version` 테이블에 revision `cc92b33c6709` (Airflow 자체 관리)
- Collation: 소스 + 타겟 전체 `utf8mb4_general_ci` 통일
- 신규 빈 테이블: `configs`, `stock_fundamentals`, `daily_macro_insights`, `global_macro_snapshots` — DAG/서비스가 자동 채움

### 이관 불가 테이블 (prime-jennie에 대응 없음)
BACKTEST_TRADELOG, AGENT_COMMANDS, OPTIMIZATION_HISTORY, RAG_CACHE, FINANCIAL_DATA, INDUSTRY_COMPETITORS, EVENT_IMPACT_RULES, SECTOR_RELATION_STATS, COMPETITOR_BENEFIT_EVENTS, FACTOR_METADATA, FACTOR_PERFORMANCE, NEWS_FACTOR_STATS, LLM_DECISION_LEDGER, SHADOW_RADAR_LOG, MARKET_FLOW_SNAPSHOT, STOCK_MINUTE_PRICE, DIVIDEND_HISTORY

---

## 다음 할 일 (Next Steps)

### 우선순위 높음
- [x] 모의 트레이딩 테스트 — 전체 파이프라인 (scout → scanner → buyer → seller → monitor) 정상 동작 확인 ✅
- [x] Airflow DAG 동작 확인 — 스케줄 트리거 및 데이터 수집 파이프라인 검증 ✅
- [ ] Cloudflare: `jenkins.yj-ai-lab.com` 라우팅 삭제 (Zero Trust 대시보드)

### 중간
- [x] Self-hosted runner systemd 서비스 등록 (재부팅 후 자동 시작) ✅
- [x] Grafana 대시보드 구성 — Loki 로그 소스 연결, 서비스별 모니터링 패널 ✅ (Dashboard System 페이지로 대체)

### CI/CD 개선
- [x] deploy.yml: `sleep 10` → healthcheck 기반 대기로 전환 ✅
- [x] deploy.yml: CI 통과 후에만 배포되도록 연동 ✅
- [x] deploy.yml: 배포 후 헬스체크 단계 추가 ✅

---

## 핵심 결정사항 (Key Decisions)

1. **Alembic 버전 테이블 분리**: `alembic_version_app` 사용 — Airflow와 같은 DB 공유 시 필수
2. **Collation 통일**: 모든 관련 테이블 `utf8mb4_general_ci`로 변환 — MariaDB 10.11 기본값(`uca1400_ai_ci`)과 다르므로 주의
3. **레거시 테이블 유지**: 소스 테이블 삭제하지 않음 — my-prime-jennie가 여전히 참조 가능

---

## 주의사항 (Warnings)

- `stock_daily_prices_old` 테이블은 삭제 완료 (레거시 동명 테이블 백업이었음)
- 레거시 소스 테이블의 collation이 `utf8mb4_general_ci`로 변경됨 — my-prime-jennie에 영향 없음 (ORM 사용)
- `migrate_from_legacy.py`는 멱등성 보장 (타겟에 데이터 있으면 스킵) — 재실행 안전

---

## Context for Next Session

다음 세션 시작 시 아래 파일들을 먼저 읽어주세요:
- `docker-compose.yml` — 전체 서비스 구성
- `dags/` — Airflow DAG 파일들
- `prime_jennie/infra/database/models.py` — DB 스키마 정의
- `scripts/migrate_from_legacy.py` — 마이그레이션 스크립트 (참고용)
