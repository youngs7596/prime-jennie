# Session Handoff - 2026-02-25-12-06

## 작업 요약 (What was done)

### 1. Watermark DB 동기화 (Monitor → DB)
- **문제**: Monitor가 Redis에 high_watermark를 실시간 추적하지만 DB에는 쓰지 않음 (DB는 sync-positions Job에서만 갱신)
- **해결**: `refresh_positions()` 5분 주기로 Redis watermark → DB 배치 동기화
- 변경 파일:
  - `prime_jennie/infra/database/repositories.py` — `bulk_update_watermarks()` 추가
  - `prime_jennie/services/monitor/app.py` — `_sync_watermarks_to_db()` 메서드 + 5분 주기 호출

### 2. Dashboard 실시간 포지션 (Live P&L)
- **목표**: Portfolio 페이지에서 종목별 실시간 수익률 표시
- **설계**: Monitor(tick) → Redis `monitoring:live_positions` (30초 갱신, 120초 TTL) → Dashboard API `/portfolio/live` → Frontend (10초 폴링)
- **핵심**: KIS API 추가 호출 없음 — Monitor의 WebSocket 틱 데이터 재활용
- 변경 파일:
  - `prime_jennie/services/monitor/app.py` — `_publish_live_snapshot()` 30초 스로틀
  - `prime_jennie/services/dashboard/routers/portfolio.py` — `/portfolio/live` 엔드포인트 추가
  - `frontend/src/lib/api.ts` — `LivePositionsResponse` + `useLivePositions()` 훅
  - `frontend/src/pages/Portfolio.tsx` — 실시간 P&L 테이블 (수익률 색상, 요약 바)

### 3. 분봉 수집 대상 확대 (Jobs)
- 시가총액 상위 30종목 + 최신 워치리스트 종목으로 확대
- dict 기반 중복 제거
- 변경 파일: `prime_jennie/services/jobs/app.py`

### 4. DeepSeek Reasoning Mode Switch
- `deepseek-reasoner` 모델에 reasoning 전용 파라미터 적용
- 변경 파일: `prime_jennie/infra/llm/providers/deepseek_cloud.py`

### 5. risk_tag 활용 (CAUTION 포지션 축소)
- CAUTION 태그 종목 position sizing 0.7x 적용
- 변경 파일:
  - `prime_jennie/services/buyer/position_sizing.py`
  - `prime_jennie/services/buyer/executor.py`
  - `prime_jennie/domain/trading.py` — `SellReason.BREAKEVEN_STOP` 추가

### 6. Scout watchlist_histories DB 저장
- Redis뿐 아니라 DB에도 워치리스트 이력 저장 (plan 수립 완료, 코드 반영은 별도 세션에서)
- 변경 파일: `prime_jennie/services/scout/analyst.py` (minor fix)

## 현재 상태 (Current State)
- 모든 서비스 정상 운영 중 (장중)
- price-monitor, dashboard, job-worker 이미 재배포 완료 (로컬 docker compose)
- git push는 장중이라 보류 (15:30 이후 push 필요)
- development 브랜치, origin보다 8 커밋 ahead

## 다음 할 일 (Next Steps)
- [ ] **장 종료 후 git push** (15:30 KST 이후)
- [ ] Scout watchlist_histories DB 저장 연결 (plan 파일 참조: `snuggly-crunching-tiger.md`)
- [ ] 월간 ROE 갱신 Job 구현 (stock_fundamentals 테이블)
- [ ] 에스엘 급등 원인 심층 분석 (52주 신고가, 방산 모멘텀)

## Context for Next Session
다음 세션 시작 시 아래 파일들을 먼저 읽어주세요:
- `.ai/sessions/session-2026-02-25-12-06.md` — 이 핸드오프 파일
- `prime_jennie/services/monitor/app.py` — watermark sync + live snapshot 로직
- `prime_jennie/services/scout/app.py` — watchlist DB 저장 연결 대상
- `.ai/TODO.md` — 전체 TODO 목록

## 핵심 결정사항 (Key Decisions)
- **Live P&L에 KIS API 직접 호출 안 함**: Monitor가 이미 WebSocket으로 틱을 받고 있으므로, Redis에 캐싱 후 Dashboard가 읽는 구조. API rate limit 걱정 없음
- **Watermark sync 5분 주기**: 틱마다 DB 쓰기는 과부하, 5분 배치가 적절한 타협점
- **분봉 수집 워치리스트 포함**: 백테스트용 데이터이므로 당장 안 쓰여도 수집 유지

## 주의사항 (Warnings)
- 장중 git push 금지 (Gateway WebSocket 끊김 위험)
- 8 커밋이 아직 push 안 됨 — 장 종료 후 반드시 push
- Scout DB 저장 plan은 아직 미구현 (plan 파일만 있음)
