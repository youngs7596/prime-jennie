# Session Handoff - 2026-02-19-14-00

## 작업 요약 (What was done)

### Audit 수정 (Task #34-37): 런타임 버그 6건 수정
1. `news/app.py` — `get_redis_client` → `get_redis` (존재하지 않는 함수 import)
2. `telegram/app.py` — `import os`를 파일 상단으로 이동 (NameError 방지)
3. `domain/config.py` — `InfraConfig.qdrant_url` 필드 추가 (AttributeError 방지)
4. `buyer/executor.py` — 매수 성공 후 `_increment_buy_count()` 호출 추가 (일일 매수 제한 작동)
5. `briefing/reporter.py` — `TELEGRAM_CHAT_ID` → `TELEGRAM_CHAT_IDS` (docker-compose 일치)
6. `telegram/app.py` — `TELEGRAM_ALLOWED_CHAT_IDS` → `TELEGRAM_CHAT_IDS` (docker-compose 일치)

### Scanner Tick Feed (Task #36): KIS WebSocket 실시간 체결가 연동
- `gateway/streamer.py` — KISWebSocketStreamer (WebSocket → Redis kis:prices)
- `gateway/app.py` — POST /api/realtime/subscribe, GET /api/realtime/status 추가
- `scanner/app.py` — Lifespan + 백그라운드 tick consumer (XREADGROUP kis:prices)
- `pyproject.toml` — websocket-client, pybreaker, slowapi 의존성 추가

### 프로덕션 블로커 수정 (Task #38): 5건
1. `Dockerfile` — 잘못된 bash 문법 pip install 수정
2. `docker-compose.yml` — Airflow (webserver + scheduler) 서비스 추가
3. `services/jobs/app.py` — job-worker 서비스 신규 (port 8095, 18개 엔드포인트)
4. LLM usage recording — BaseLLMProvider._record_usage() + 3개 provider 연동
5. `dashboard/routers/system.py` — telegram, news-pipeline, job-worker, daily-briefing 모니터링 추가

### 기타
- `.ai/RULES.md` — 프로젝트 룰 파일 생성 (세션 핸드오프 절차, 빌드/테스트 가이드)
- `.ai/sessions/` — 세션 기록 디렉토리 생성
- `.gitignore` — node_modules, .ruff_cache, frontend/dist 등 누락 항목 추가

## 현재 상태 (Current State)

### 프로젝트 완성도: ~99%
- **446 tests 전체 통과** (0 failures, 1 warning)
- 모든 서비스 import 정상, 런타임 버그 수정 완료
- Docker Compose: 인프라(7) + 앱(15) = 22개 서비스 정의

### 프로덕션 준비 상태
- Dockerfile 빌드 가능
- 모든 DAG → 서비스 연결 완료 (job-worker, macro-council, price-monitor)
- LLM 사용 통계 자동 기록
- 시스템 헬스 모니터링 12개 서비스 커버

### 남은 작업 (NICE-TO-HAVE)
- [x] 데이터 마이그레이션 스크립트 (`scripts/migrate_from_my_prime_jennie.py`) ✅
- [x] Integration/Contract 테스트 추가 (현재 빈 디렉토리) ✅
- [x] job-worker 스텁 엔드포인트 실구현 (collect-foreign-holding, collect-dart 등) ✅
- [x] Telegram collector 서비스 (매크로 Council 브리핑 데이터 소스) ✅
- [x] Airflow connections 설정 문서 (job_worker, macro_council, price_monitor) ✅

## 다음 할 일 (Next Steps)

- [x] 프로덕션 배포 전 Docker 빌드 테스트 (`docker compose --profile real build`) ✅
- [x] Airflow 초기 설정 (DB init, connections 생성) ✅
- [x] 데이터 마이그레이션 (my-prime-jennie DB → prime-jennie DB) ✅
- [x] 실거래 테스트 (MOCK 모드) ✅

## Context for Next Session
다음 세션 시작 시 아래 파일들을 먼저 읽어주세요:
- `CLAUDE.md` — 프로젝트 전체 구조
- `.ai/RULES.md` — AI 어시스턴트 룰
- `docker-compose.yml` — 서비스 구성 (22개)
- `prime_jennie/services/jobs/app.py` — job-worker 서비스 (스텁 엔드포인트 실구현 필요)

## 핵심 결정사항 (Key Decisions)
- **LLM usage recording**: BaseLLMProvider에 `_record_usage()` 메서드 추가 → 각 provider의 generate()에서 호출. CloudFailover는 inner provider가 자동 기록하므로 추가 불필요.
- **job-worker**: 별도 서비스로 분리 (port 8095). DAG 구조 변경 없이 Airflow http_conn_id="job_worker" 유지.
- **Airflow**: LocalExecutor + MariaDB 백엔드 (별도 PostgreSQL 불필요). 앱 이미지 공유.

## 주의사항 (Warnings)
- job-worker의 일부 엔드포인트는 스텁 (collect-foreign-holding, collect-dart 등)
- Airflow 서비스는 별도 DB 초기화 필요 (`airflow db init`)
- docker-compose에서 Airflow는 앱 이미지를 공유하므로 apache-airflow가 이미지에 포함되어야 함 → pyproject.toml의 `[project.optional-dependencies].airflow` 참조
