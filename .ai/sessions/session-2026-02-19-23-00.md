# Session Handoff - 2026-02-19-23-00

## 작업 요약 (What was done)

### Dryrun 모드 구현 및 E2E 테스트

buy-executor/sell-executor에 dryrun 모드를 구현하여 KIS API 실주문 없이
전체 트레이딩 파이프라인을 검증했다.

#### 변경된 파일
| 파일 | 변경 내용 |
|------|----------|
| `prime_jennie/services/buyer/executor.py` | `_place_order()` 상단에 dryrun 체크 추가 — `DRYRUN-0000` 가짜 성공 반환 |
| `prime_jennie/services/seller/executor.py` | `_execute_sell()` 주문 직전에 dryrun 체크 추가 — cooldown/cleanup 유지 |
| `prime_jennie/services/base.py` | `create_app` lifespan에서 `setup_logging()` 호출 추가 |
| `prime_jennie/infra/redis/client.py` | `socket_timeout` 5→15초로 증가 |
| `docker-compose.yml` | `APP_DRY_RUN: "true"` 추가 후 테스트 완료 → 제거 |

#### Dryrun 테스트 결과
| Executor | 종목 | 결과 |
|----------|------|------|
| buy-executor | 005930 삼성전자 | `[DRYRUN] BUY 96 shares at 190000` — 성공 |
| sell-executor | 023530 롯데쇼핑 | `[DRYRUN] SELL 1 shares at 111200` — 성공 |

#### 발견 및 수정한 기존 버그
1. **Redis socket_timeout == XREADGROUP block**: `socket_timeout=5s`와 `block=5000ms`가 동일하여 매번 TimeoutError 발생 → `socket_timeout=15s`로 수정
2. **setup_logging() 미호출**: `create_app`에서 로깅 초기화가 없어 INFO 레벨 로그가 출력되지 않음 → lifespan에서 `setup_logging()` 호출 추가

---

## 현재 상태 (Current State)

### 서비스: 전체 정상 가동
- buy-executor, sell-executor: 실주문 모드 (APP_DRY_RUN 제거됨)
- dryrun 코드는 유지 — `APP_DRY_RUN=true` 환경변수로 언제든 재활성화 가능

### 보유 포지션 (테스트 시점)
| 종목코드 | 종목명 | 수량 | 매입가 | 수익률 |
|----------|--------|-----:|-------:|-------:|
| 023530 | 롯데쇼핑 | 99 | 109,896 | +1.18% |
| 028670 | 팬오션 | 1,000 | 5,430 | +1.84% |

### Redis Stream 수동 주입 방법 (참고)
```bash
# buy signal (payload JSON 형식 필수)
docker compose exec redis redis-cli XADD stream:buy-signals '*' payload '{"stock_code":"005930","stock_name":"삼성전자","signal_type":"MOMENTUM","signal_price":55000,"llm_score":85,"hybrid_score":80,"is_tradable":true,"trade_tier":"TIER1","risk_tag":"NEUTRAL","market_regime":"SIDEWAYS","source":"manual","timestamp":"2026-02-19T23:00:00+09:00","position_multiplier":1.0}'

# sell signal
docker compose exec redis redis-cli XADD stream:sell-orders '*' payload '{"stock_code":"023530","stock_name":"롯데쇼핑","sell_reason":"MANUAL","current_price":111200,"quantity":1,"timestamp":"2026-02-19T23:10:00+09:00"}'
```

주의: `TypedStreamPublisher`가 `{"payload": json}` 형식으로 발행하므로, 수동 주입 시 반드시 `payload` 키로 감싸야 함. 개별 필드를 flat하게 넣으면 `Empty payload` 에러 발생.

### Enum 값 참고
- `signal_type`: GOLDEN_CROSS, RSI_REBOUND, MOMENTUM, MOMENTUM_CONTINUATION, DIP_BUY, VOLUME_BREAKOUT, WATCHLIST_CONVICTION
- `trade_tier`: TIER1, TIER2, BLOCKED
- `market_regime`: STRONG_BULL, BULL, SIDEWAYS, BEAR, STRONG_BEAR
- `sell_reason`: PROFIT_TARGET, STOP_LOSS, TRAILING_STOP, RSI_OVERBOUGHT, TIME_EXIT, RISK_OFF, MANUAL

---

## 다음 할 일 (Next Steps)

### 우선순위 높음
- [ ] Airflow DAG 동작 확인 — 스케줄 트리거 및 데이터 수집 파이프라인 검증
- [x] Cloudflare: `jenkins.yj-ai-lab.com` 라우팅 삭제 (Zero Trust 대시보드) ✅ 완료

### 중간
- [ ] Self-hosted runner systemd 서비스 등록 (재부팅 후 자동 시작)
- [ ] Grafana 대시보드 구성 — Loki 로그 소스 연결, 서비스별 모니터링 패널

### CI/CD 개선
- [ ] deploy.yml: `sleep 10` → healthcheck 기반 대기로 전환
- [ ] deploy.yml: CI 통과 후에만 배포되도록 연동
- [ ] deploy.yml: 배포 후 헬스체크 단계 추가

---

## 핵심 결정사항 (Key Decisions)

1. **Dryrun은 환경변수 제어**: `APP_DRY_RUN=true`로 docker-compose에서 on/off — 코드 변경 없이 전환 가능
2. **Dryrun 위치**: buy는 `_place_order()` 최상단, sell은 `_execute_sell()` 주문 직전 — 검증 로직은 그대로 실행
3. **setup_logging은 base.py에서 일괄 호출**: 개별 서비스에서 중복 호출 불필요

---

## 주의사항 (Warnings)

- Airflow 웹 포트: **8085** (KIS Gateway 8080과 구분)
- Redis stream 수동 주입 시 enum 값 정확히 입력 필요 (Pydantic validation 실패함)
- `scripts/migrate_from_legacy.py`의 ruff format도 이번 세션에서 적용됨

---

## Context for Next Session

다음 세션 시작 시 아래 파일들을 먼저 읽어주세요:
- `docker-compose.yml` — 전체 서비스 구성
- `dags/` — Airflow DAG 파일들
- `prime_jennie/services/base.py` — 서비스 공통 팩토리 (logging 포함)
- `prime_jennie/infra/redis/streams.py` — TypedStreamConsumer/Publisher
