# Session Handoff - 2026-02-19-18-10

## 작업 요약 (What was done)

### 1. CI/CD 파이프라인 구축 및 수정
- `.github/workflows/ci.yml`: `pip install -r requirements.txt` → `pip install -e ".[dev]"` 수정 (pyproject.toml 기반)
- `.github/workflows/deploy.yml`: `.env` 복사 단계 추가, infra 프로필 기동 추가, 배포 순서 정리
- Self-hosted GitHub Actions runner 설치 및 등록 (`/home/youngs75/actions-runner/`)

### 2. 코드 품질 (Ruff Lint/Format)
- 596건 ruff lint 에러 전체 수정 (자동 506건 + 수동 18건)
- `pyproject.toml`에 `ignore = ["B008", "UP046"]` 추가
- 62개 파일 ruff format 적용
- 446 테스트 전체 통과

### 3. Docker 이미지 빌드 수정
- `Dockerfile`: `gcc`, `pkg-config`, `libmariadb-dev` 시스템 패키지 추가, `pip install -e ".[airflow]"`, `COPY dags/` 추가
- `pyproject.toml`: `beautifulsoup4`, `mysqlclient`, `aiomysql` 의존성 추가
- 백엔드 + 프론트엔드 이미지 빌드 성공 확인

### 4. 배포 런타임 오류 수정 (총 12건)
- MariaDB: `--port=3307` 추가 (host 네트워크 3306 충돌)
- MariaDB: DB_USER/DB_NAME env var로 전환 (기존 볼륨 `jennie`/`jennie_db` 호환)
- Airflow: `webserver` → `api-server` (Airflow 3.x), healthcheck `/api/v2/monitor/health`
- Airflow: `mysql+pymysql` → `mysql+mysqldb`
- Redis: infra 프로필 미기동 → deploy.yml에 추가
- Nginx: `proxy_pass http://dashboard:8090` → `http://127.0.0.1:8090` (host 네트워크)
- Loki: `user: "1000"` 추가 (볼륨 권한)
- Grafana: 사용자가 수동으로 `chown 472:472` 처리

### 5. vLLM 설정 (my-prime-jennie 참조)
- 이미지: `latest` → `v0.15.1` 고정
- GPU: `runtime: nvidia` → `deploy.resources.reservations.devices (driver: nvidia, count: all)`
- 양자화: `awq` → `awq_marlin`, `--dtype half`
- 볼륨: `/docker_data/vllm_cache` → `/docker_data/huggingface_cache`
- `ipc: host`, `HF_HUB_OFFLINE: "1"` 추가
- embed: `--max-model-len 256`, `--enforce-eager` 추가

### 6. Cloudflare Tunnel 설정
- `docker-compose.yml`에 `cloudflared` 서비스 추가 (infra 프로필)
- `.env`에 `CLOUDFLARE_TUNNEL_TOKEN` 추가 (기존 my-prime-jennie 토큰 재사용)
- `dashboard.yj-ai-lab.com` → `127.0.0.1:80` 연결 확인

### 변경된 파일 목록
| 파일 | 변경 내용 |
|------|----------|
| `.github/workflows/ci.yml` | pip install 방식 수정 |
| `.github/workflows/deploy.yml` | .env 복사, infra 기동, 배포 순서 |
| `Dockerfile` | 시스템 패키지, airflow 의존성, dags 복사 |
| `docker-compose.yml` | MariaDB 포트, DB env var, vLLM v0.15.1, Loki user, Airflow 3.x, cloudflared |
| `pyproject.toml` | bs4, mysqlclient, aiomysql 의존성, ruff ignore 규칙 |
| `frontend/nginx.conf` | proxy_pass 127.0.0.1 변경 |
| `prime_jennie/**` (~95 파일) | ruff lint/format 수정 |
| `.env` | CLOUDFLARE_TUNNEL_TOKEN 추가 |

---

## 현재 상태 (Current State)

### 서비스 상태: 23개 전체 정상 가동
| 분류 | 서비스 | 포트 | 상태 |
|------|--------|------|------|
| Infra | mariadb | 3307 | healthy |
| Infra | redis | 6379 | healthy |
| Infra | qdrant | 6333/6334 | healthy |
| AI/ML | vllm-llm (EXAONE 32B AWQ) | 8001 | healthy |
| AI/ML | vllm-embed (KURE-v1) | 8002 | healthy |
| Observability | loki | 3100 | Up |
| Observability | grafana | 3300 | Up |
| Network | cloudflared | - | Up |
| Trading | kis-gateway | 8080 | healthy |
| Trading | buy-scanner | 8081 | healthy |
| Trading | buy-executor | 8082 | healthy |
| Trading | sell-executor | 8083 | healthy |
| Trading | price-monitor | 8088 | healthy |
| Analysis | scout-job | 8087 | healthy |
| Analysis | macro-council | 8089 | healthy |
| Analysis | news-pipeline | 8092 | healthy |
| Frontend | dashboard (API) | 8090 | healthy |
| Frontend | dashboard-frontend (nginx) | 80 | Up |
| Jobs | job-worker | 8095 | healthy |
| Jobs | daily-briefing | 8086 | healthy |
| Jobs | telegram | 8091 | healthy |
| Airflow | airflow-webserver | 8085 | healthy |
| Airflow | airflow-scheduler | - | healthy |

### CI/CD
- GitHub Actions CI (ci.yml): main/development push 시 lint + test + frontend build
- GitHub Actions Deploy (deploy.yml): development push 시 self-hosted runner 배포
- Self-hosted runner: `/home/youngs75/actions-runner/` 에서 nohup 실행 중

### 외부 접근
- `dashboard.yj-ai-lab.com` → Cloudflare Tunnel → nginx(80) → dashboard API(8090)

### 알려진 이슈
- Grafana, Loki, dashboard-frontend, cloudflared: healthcheck 미설정 (정상 동작은 확인됨)
- Cloudflare Tunnel에 `jenkins.yj-ai-lab.com` 라우팅 잔존 → Cloudflare Zero Trust 대시보드에서 수동 삭제 필요
- Self-hosted runner가 nohup으로 실행 중 (시스템 재부팅 시 수동 재시작 필요, systemd 서비스 등록 미완)

---

## 다음 할 일 (Next Steps)

### 우선순위 높음
- [x] Airflow 초기 설정 — entrypoint로 DB migrate + admin 유저 + HTTP connections 자동화 완료
- [ ] 데이터 마이그레이션 — my-prime-jennie DB에서 필요한 데이터 이관 (종목 마스터, 과거 매매 이력 등)
- [ ] Cloudflare: `jenkins.yj-ai-lab.com` 라우팅 삭제 (Zero Trust 대시보드)

### 중간
- [ ] 모의 트레이딩 테스트 — 전체 파이프라인 (scout → scanner → buyer → seller → monitor) 정상 동작 확인
- [ ] Self-hosted runner systemd 서비스 등록 (재부팅 후 자동 시작)
- [ ] Grafana 대시보드 구성 — Loki 로그 소스 연결, 서비스별 모니터링 패널

### CI/CD 개선 (리뷰 반영)
- [ ] deploy.yml: `sleep 10` → healthcheck 기반 대기로 전환 (MariaDB ping + Redis PONG)
- [ ] deploy.yml: CI 통과 후에만 배포되도록 연동 (`workflow_run` 또는 `needs`)
- [ ] deploy.yml: .env 복사 시 파일 존재 체크 추가
- [ ] deploy.yml: 배포 후 헬스체크 단계 추가 (curl health endpoint)
- [ ] ci.yml: lint job에서 `pip install ruff`만으로 경량화
- [ ] ci.yml: `pull_request` 트리거에 development 브랜치 추가
- [ ] ci.yml: frontend-build에 ESLint 추가 (프로젝트 커질 때)

### 나중에
- [ ] 알림 체계 점검 — Telegram 봇 정상 동작 확인
- [ ] 성능 튜닝 — vLLM KV 캐시 (현재 max concurrency 2.38x), WSL pin_memory 이슈
- [ ] 프로덕션 보안 — .env 파일 권한 제한, Grafana 기본 비밀번호 변경
- [ ] deploy.yml: 롤백 전략 구현 (이전 이미지 태깅 + 실패 시 복구)

---

## Context for Next Session

다음 세션 시작 시 아래 파일들을 먼저 읽어주세요:
- `docker-compose.yml` - 전체 서비스 구성 (23개 서비스)
- `dags/` - Airflow DAG 파일들 (초기 설정 작업용)
- `prime_jennie/domain/config.py` - 환경변수 기반 설정 구조
- `.github/workflows/deploy.yml` - 배포 워크플로우

---

## 핵심 결정사항 (Key Decisions)

1. **vLLM v0.15.1 고정**: latest 사용 시 AWQ 양자화 호환 문제 발생, my-prime-jennie에서 검증된 버전 사용
2. **GPU 설정**: `runtime: nvidia` 대신 `deploy.resources.reservations.devices (driver: nvidia, count: all)` 방식 — Docker Compose에서 더 안정적
3. **network_mode: host**: 모든 서비스가 호스트 네트워크 공유, 포트 매핑 불필요, 서비스 간 localhost 통신
4. **Cloudflare Tunnel**: 커스텀 Dockerfile 대신 공식 `cloudflare/cloudflared:latest` 이미지 + 환경변수 토큰 방식으로 간소화
5. **DB 호환**: 기존 MariaDB 볼륨(`/docker_data/mariadb_data`)의 유저/DB명(jennie/jennie_db) 유지하여 데이터 보존

---

## 주의사항 (Warnings)

- `/docker_data/` 하위 볼륨들은 my-prime-jennie와 공유됨 (mariadb_data, huggingface_cache 등) — 삭제 금지
- `.env` 파일에 실제 KIS 실계좌 키 포함 — git에 절대 커밋하지 않을 것 (.gitignore 적용됨)
- vLLM 두 서비스가 같은 GPU(RTX 3090) 공유 — embed는 VRAM 5%만 사용하도록 제한
- Airflow DB는 MariaDB(jennie_db)를 공유 — 별도 DB 분리 미완
- Self-hosted runner work 디렉토리(`/home/youngs75/actions-runner/_work/`)는 별도 checkout이므로 프로젝트 디렉토리의 `.env`를 복사하는 deploy step이 필수
