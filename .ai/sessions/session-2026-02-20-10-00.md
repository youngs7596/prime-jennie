# Session Handoff - 2026-02-20-10-00

## 작업 요약 (What was done)

### Price Monitor: HTTP 폴링 → Redis Stream 실시간 전환

price-monitor가 30초 간격 HTTP 폴링(`kis.get_positions()`)에서
Redis Stream(`kis:prices`) 실시간 틱 소비로 전환되었다.
buy-scanner와 동일한 XREADGROUP 패턴을 사용한다.

#### 변경 파일

| 파일 | 변경 내용 |
|------|----------|
| `prime_jennie/services/monitor/app.py` | 대폭 리팩토링 — 폴링 루프 제거, Redis Stream tick consumer 패턴 적용 |
| `tests/unit/services/test_monitor_app.py` | 신규 — `process_tick()`, `refresh_positions()` 등 11개 테스트 |

#### PriceMonitor 클래스 변경

- **추가**: `_positions: dict[str, Position]` 인메모리 딕셔너리
- **추가**: `_rsi_cache: dict[str, float | None]` (RSI는 5분 주기로만 계산, 틱마다 재계산하지 않음)
- **추가**: `refresh_positions()` — `kis.get_positions()` → `_positions` 갱신, RSI 일괄 계산, 사라진 포지션 Redis 상태 정리
- **추가**: `process_tick(stock_code, price, high)` — 보유 종목이면 `_evaluate_position()` → `_emit_sell_order()` 체인
- **변경**: `_evaluate_position()`에서 RSI를 `_rsi_cache.get()` 조회로 변경 (이전: 매번 `_compute_rsi()` 호출)
- **삭제**: `run()`, `stop()`, `_tick()`, `_get_positions()`, `_stop_event` (폴링 루프 전체)

#### 모듈 레벨 변경

- **추가**: `_consume_ticks(r, monitor)` — consumer group `monitor-group`, consumer `monitor-1`로 `kis:prices` XREADGROUP. 5분마다 `refresh_positions()` + 신규 종목 gateway 구독
- **추가**: `_subscribe_to_gateway(codes)` — httpx POST `/api/realtime/subscribe`
- **변경**: `create_monitor_app()` → `lifespan` + `create_app()` 직접 호출 (scanner 패턴)
- **삭제**: `/start`, `/stop` 엔드포인트 → `/status`, `/refresh-positions` 엔드포인트

#### 데이터 흐름 (변경 후)

```
KIS WebSocket → Gateway streamer → Redis XADD kis:prices
                                        |
                    +-------------------+-------------------+
                    |                                       |
            [scanner-group]                         [monitor-group]
            buy-scanner                             price-monitor
            process_tick(code,price,vol)             process_tick(code,price,high)
                    |                                       |
            매수 시그널 평가                          매도 규칙 평가
            stream:buy-signals                      stream:sell-orders

별도 5분 주기: kis.get_positions() → _positions 갱신 + RSI 계산
```

---

## 현재 상태 (Current State)

### 코드 상태
- `py_compile`: 통과
- `pytest tests/ -x -q`: **457 passed** (이전 446 → +11 monitor 테스트)
- 아직 커밋/배포 안됨 — 이 세션에서 커밋 예정

### 미배포 변경사항 (staging 외)
- `docker-compose.yml`, `frontend/*`, 기타 서비스 파일들 (이전 세션 작업) 아직 unstaged

---

## 다음 할 일 (Next Steps)

### 우선순위 높음
- [x] 리빌드 & 재배포: `docker compose build price-monitor && docker compose --profile real up -d price-monitor` ✅
- [x] 로그 확인: `docker compose logs price-monitor --tail 30` ✅
  - "Tick consumer started: stream=kis:prices group=monitor-group" 확인
  - "Positions refreshed: N held" 확인
  - "Gateway subscribe: added=N" 확인

### 중간
- [x] 장중 실시간 매도 시그널 발행 확인 (stream:sell-orders 모니터링) ✅
- [x] 기존 unstaged 변경사항 정리/커밋 (docker-compose.yml, frontend 등) ✅

---

## 핵심 결정사항 (Key Decisions)

1. **WebSocket 직접 연결이 아닌 Redis Stream 소비**: Gateway가 유일한 WebSocket 클라이언트, monitor는 `kis:prices` 스트림의 별도 consumer group(`monitor-group`)으로 소비
2. **RSI는 5분 주기 배치 계산**: 틱마다 KIS API 호출하면 rate limit 위험 → `_rsi_cache`에 캐시, `refresh_positions()` 시에만 갱신
3. **전량 매도 시 인메모리 즉시 제거**: `_positions`와 `_rsi_cache`에서 삭제하여 이후 틱 무시

---

## Context for Next Session

다음 세션 시작 시 아래 파일들을 먼저 읽어주세요:
- `prime_jennie/services/monitor/app.py` — 리팩토링된 price-monitor
- `prime_jennie/services/scanner/app.py` — 동일 패턴 참조 (buy-scanner)
- `prime_jennie/services/monitor/exit_rules.py` — 매도 규칙 (변경 없음)
- `tests/unit/services/test_monitor_app.py` — 신규 테스트
